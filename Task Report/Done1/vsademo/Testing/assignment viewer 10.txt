Controller 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\StepController.php
replace viewAssignment() function 

    public function viewAssignment($id)
    {
        // $teammemberall = Teammember::where('role_id', '=', 15)->orwhere('role_id', '=', 14)->where('status', '=', 1)->with('title', 'role')->get();
        $teammemberall = Teammember::whereIn('role_id', [15, 14])
            ->where('status', 1)
            ->with('title', 'role')
            ->get();

        $assignmentid = Assignmentmapping::where('assignmentgenerate_id', $id)->select('assignment_id')->pluck('assignment_id')->first();
        // dd($assignmentgenerateid); 
        $assignmentcheck =
            DB::table('financialstatementclassifications')
            ->where('assignmentgenerate_id', $id)
            ->get();

        if ($assignmentcheck->isEmpty()) {
            $assignmentcheckDatas =
                DB::table('financialstatementclassifications')
                ->where('assignment_id', $assignmentid)
                ->where('assignmentgenerate_id', null)
                ->get();
            //dd($assignmentcheckDatas);
        } else {
            $assignmentcheckDatas =
                DB::table('financialstatementclassifications')
                ->where('assignment_id', $assignmentid)
                ->where('assignmentgenerate_id', null)
                ->orwhere('assignmentgenerate_id',  $id)
                ->get();
        }

        //  dd($assignmentcheckDatas);

        $assignmentbudgetingDatas = DB::table('assignmentbudgetings')
            ->join('clients', 'clients.id', 'assignmentbudgetings.client_id')
            ->join('assignments', 'assignments.id', 'assignmentbudgetings.assignment_id')
            ->join('assignmentmappings', 'assignmentmappings.assignmentgenerate_id', 'assignmentbudgetings.assignmentgenerate_id')
            ->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
            ->where('assignmentbudgetings.assignmentgenerate_id', $id)
            ->select(
                'assignmentbudgetings.*',
                'assignmentmappings.*',
                'clients.client_name',
                'clients.client_code',
                'assignmentteammappings.type',
                'assignments.assignment_name'
            )->first();
        // dd($assignmentbudgetingDatas);
        $teammemberDatas = DB::table('assignmentmappings')
            ->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
            ->leftjoin('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')
            ->leftjoin('titles', 'titles.id', 'teammembers.title_id')
            ->leftjoin('roles', 'roles.id', 'teammembers.role_id')
            ->where('assignmentmappings.assignmentgenerate_id', $id)
            ->select('teammembers.*', 'roles.rolename', 'assignmentteammappings.type', 'titles.title', 'assignmentteammappings.id As assignmentteammappingsId', 'assignmentteammappings.status as assignmentteammappingsStatus', 'assignmentmappings.assignmentgenerate_id as assignmentgenerateid', 'assignmentteammappings.teamhour', 'assignmentmappings.leadpartner', 'assignmentteammappings.viewerteam')
            ->orderBy('assignmentteammappingsId', 'desc')
            ->get();
        // dd($teammemberDatas, 1);
        $contactDatas = DB::table('assignmentbudgetings')
            ->join('clients', 'clients.id', 'assignmentbudgetings.client_id')
            ->join('clientcontacts', 'clientcontacts.client_id', 'clients.id')
            ->where('assignmentbudgetings.assignmentgenerate_id', $id)
            ->select(
                'clientcontacts.*'
            )->get();
        $udinDatas = DB::table('assignmentbudgetingudins')
            ->join('teammembers', 'teammembers.id', 'assignmentbudgetingudins.created_by')
            ->join('roles', 'roles.id', 'teammembers.role_id')
            ->where('assignmentbudgetingudins.assignment_generate_id', $id)
            ->select('teammembers.*', 'assignmentbudgetingudins.udin', 'assignmentbudgetingudins.udindate', 'assignmentbudgetingudins.id as assignmentbudgetingudinsid', 'roles.rolename', 'assignmentbudgetingudins.partner', 'assignmentbudgetingudins.created_at as created')->get();
        // dd($contactDatas);

        $leadpartner = DB::table('assignmentmappings')
            ->join('teammembers as team', 'team.id', 'assignmentmappings.leadpartner')
            ->leftJoin('titles', 'titles.id', '=', 'team.title_id')
            ->where('assignmentmappings.assignmentgenerate_id', $id)
            ->select('team.id', 'team.team_member', 'team.staffcode',  'team.mobile_no', 'team.role_id', 'assignmentmappings.leadpartnerhour', 'titles.title')
            ->get();


        $otherpartner = DB::table('assignmentmappings')
            ->join('teammembers as team', 'team.id', 'assignmentmappings.otherpartner')
            ->leftJoin('titles', 'titles.id', '=', 'team.title_id')
            ->where('assignmentmappings.assignmentgenerate_id', $id)
            ->select('team.id', 'team.team_member', 'team.staffcode', 'team.mobile_no', 'team.role_id', 'assignmentmappings.otherpartnerhour', 'titles.title',)
            ->get();

        $partner = $leadpartner->merge($otherpartner);

        return view('backEnd.viewassignment', compact('partner', 'udinDatas', 'contactDatas', 'teammemberDatas', 'assignmentcheckDatas', 'assignmentbudgetingDatas', 'teammemberall'));
    }





Controller 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
app\Http\Controllers\ChecklistanswerController.php
replace teammappingUpdate() function 

    public function teammappingUpdate(Request $request)
    {
        try {
            $previous = url()->previous();
            $fulluri = parse_url($previous, PHP_URL_PATH);
            $uri = substr($fulluri, 0, strrpos($fulluri, '/'));

            $data = $request->except(['_token']);
            $previouscheck = DB::table('assignmentteammappings')
                ->where('assignmentmapping_id', $request->assignmentmapping_id)
                ->where('teammember_id', $request->teammember_id)
                ->first();

            if ($previouscheck != null) {
                if ($uri == '/assignmentlist') {
                    $output = array('msg' => 'Staff is already in team');
                    return back()->with('success', $output);
                } else {
                    $output = array('msg' => 'Staff is already in team');
                    return back()->with('success', $output);
                }
            }

            if ($previouscheck == null) {

                $assignmentmappingid = DB::table('assignmentmappings')->where('id', $request->assignmentmapping_id)->first();
                $assignmentbudgetingid = DB::table('assignmentbudgetings')
                    ->where('assignmentgenerate_id', $assignmentmappingid->assignmentgenerate_id)->first();
                if ($assignmentbudgetingid->status == 0) {
                    $data['viewerteam'] = 1;
                    Assignmentteammapping::Create($data);
                } else {
                    Assignmentteammapping::Create($data);
                }


                $assignment_name = DB::table('assignments')->where('id', $assignmentmappingid->assignment_id)
                    ->select('assignment_name')->pluck('assignment_name')->first();

                $clientname = DB::table('clients')->where('id', $assignmentbudgetingid->client_id)->select('client_name', 'client_code')->first();

                $assignmentnames = DB::table('assignmentbudgetings')->where('assignmentgenerate_id', $assignmentmappingid->assignmentgenerate_id)
                    ->select('assignmentname')->first();
                $teamemail = DB::table('teammembers')->where('id', $request->teammember_id)->select('emailid')->first();

                $assignmentpartner = DB::table('teammembers')->where('id', $assignmentmappingid->leadpartner)->select('team_member', 'staffcode')->first();
                $assignmentotherpatner = DB::table('teammembers')->where('id', $assignmentmappingid->otherpartner)->select('team_member', 'staffcode')->first();
                $teamleader =    DB::table('assignmentmappings')
                    ->leftjoin('assignmentteammappings', 'assignmentteammappings.assignmentmapping_id', 'assignmentmappings.id')
                    ->leftjoin('teammembers', 'teammembers.id', 'assignmentteammappings.teammember_id')
                    ->where('assignmentmappings.assignmentgenerate_id', $assignmentmappingid->assignmentgenerate_id)
                    // ->where('assignmentteammappings.type', '0')
                    ->select('teammembers.team_member', 'teammembers.staffcode')
                    ->get();

                $data = array(
                    'assignmentid' =>  $assignmentmappingid->assignmentgenerate_id,
                    'clientname' =>  $clientname->client_name,
                    'clientcode' =>  $clientname->client_code,
                    'assignmentname' =>  $assignmentnames->assignmentname,
                    'emailid' =>  $teamemail->emailid,
                    'assignment_name' =>  $assignment_name,
                    'assignmentpartner' =>  $assignmentpartner,
                    'otherpartner' =>  $assignmentotherpatner,
                    'teamleader' =>  $teamleader,
                );
                Mail::send('emails.assignmentassignteam', $data, function ($msg) use ($data) {
                    $msg->to($data['emailid']);
                    $msg->subject('VSA New Assignment Assigned || ' . $data['assignmentname'] . ' / ' . $data['assignmentid']);
                });
            }

            if ($uri == '/assignmentlist') {
                $output = array('msg' => 'Team Add Successfully');
                return back()->with('success', $output);
            } else {
                $output = array('msg' => 'Team Add Successfully');
                return back()->with('success', $output);
            }
        } catch (Exception $e) {
            DB::rollBack();
            Log::emergency("File:" . $e->getFile() . "Line:" . $e->getLine() . "Message:" . $e->getMessage());
            report($e);
            $output = array('msg' => $e->getMessage());
            return back()->withErrors($output)->withInput();
        }
    }






Blade 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\viewassignment.blade.php
find text    <b>Teammember List:</b>
replace teammember list box 



                <div class="row">
                    <div class="col-md-12">
                        <div class="card" style="box-shadow:0 4px 8px 0 rgba(0, 0, 0, 0.2);height:250px;">
                            <div class="card-body">
                                <div class="card-head">
                                    <b>Teammember List:</b>
                                    @if (auth()->user()->role_id != 15)
                                        <b><a data-toggle="modal" data-target="#exampleModal14"
                                                class="btn btn-info-soft btn-sm">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </b>
                                    @endif
                                </div>

                                <hr>
                                <div class="table-responsive example">
                                    <table class="table display table-bordered table-striped table-hover ">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Staff Code</th>
                                                <th>Role</th>
                                                <th>Mobile No</th>
                                                <th>Total Hour</th>
                                                <th>Patner</th>
                                                @if (auth()->user()->role_id == 13 || auth()->user()->role_id == 11)
                                                    <th>Status</th>
                                                @endif
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @php
                                                $hasData = false;
                                            @endphp
                                            @foreach ($teammemberDatas as $teammemberData)
                                                @if ($teammemberData->viewerteam == 0)
                                                    @php
                                                        $hasData = true;
                                                    @endphp
                                                    <tr>
                                                        {{-- @php
                                                            dd($teammemberData);
                                                            $totalhour = DB::table('timesheetusers')
                                                                ->leftJoin(
                                                                    'teammembers',
                                                                    'teammembers.id',
                                                                    'timesheetusers.createdby',
                                                                )
                                                                ->where(
                                                                    'timesheetusers.assignmentgenerate_id',
                                                                    $teammemberData->assignmentgenerateid,
                                                                )
                                                                ->where('timesheetusers.createdby', $teammemberData->id)
                                                                ->select(DB::raw('SUM(totalhour) as total_hours'))
                                                                ->first();
                                
                                                            $patnername = DB::table('assignmentmappings')
                                                                ->leftJoin(
                                                                    'teammembers',
                                                                    'teammembers.id',
                                                                    'assignmentmappings.leadpartner',
                                                                )
                                                                ->where(
                                                                    'assignmentgenerate_id',
                                                                    $teammemberData->assignmentgenerateid,
                                                                )
                                                                ->select('teammembers.team_member')
                                                                ->first();
                                                        @endphp --}}
                                                        <td>{{ $teammemberData->title }}
                                                            {{ $teammemberData->team_member }}

                                                        </td>
                                                        <td>{{ $teammemberData->staffcode }}
                                                        </td>
                                                        <td>
                                                            @if ($teammemberData->type == 0)
                                                                <span>Team Leader</span>
                                                            @else
                                                                <span>Staff</span>
                                                            @endif
                                                        </td>
                                                        <td><a
                                                                href="tel:={{ $teammemberData->mobile_no }}">{{ $teammemberData->mobile_no }}</a>
                                                        </td>
                                                        {{-- <td>{{ $totalhour->total_hours ?? 0 }}</td> --}}
                                                        {{-- <td>{{ $patnername->team_member }}</td> --}}
                                                        <td>{{ $teammemberData->teamhour ?? 0 }}</td>
                                                        </td>
                                                        <td>{{ App\Models\Teammember::select('team_member')->where('id', $teammemberData->leadpartner)->first()->team_member ?? '' }}
                                                        </td>
                                                        @if (auth()->user()->role_id == 13 || auth()->user()->role_id == 11)
                                                            <td>
                                                                @if ($teammemberData->assignmentteammappingsStatus == 0)
                                                                    <a href="{{ url('/assignment/reject/' . $teammemberData->assignmentteammappingsId . '/1/' . $teammemberData->id) }}"
                                                                        onclick="return confirm('Are you sure you want to Active this teammember?');">
                                                                        <button class="btn btn-danger" data-toggle="modal"
                                                                            style="height: 16px; width: auto; border-radius: 7px; display: flex; align-items: center; justify-content: center;font-size: 11px;"
                                                                            data-target="#requestModal">Inactive</button>
                                                                    </a>
                                                                @else
                                                                    <a href="{{ url('/assignment/reject/' . $teammemberData->assignmentteammappingsId . '/0/' . $teammemberData->id) }}"
                                                                        onclick="return confirm('Are you sure you want to Inactive this teammember?');">
                                                                        <button class="btn btn-primary" data-toggle="modal"
                                                                            style="height: 16px; width: auto; border-radius: 7px; display: flex; align-items: center; justify-content: center;font-size: 11px;"
                                                                            data-target="#requestModal">Active</button>
                                                                    </a>
                                                                @endif
                                                            </td>
                                                        @endif
                                                    </tr>
                                                @endif
                                            @endforeach
                                            @if (!$hasData)
                                                <tr>
                                                    <td colspan="7" style="text-align: center;">Data not available</td>
                                                </tr>
                                            @endif
                                        </tbody>
                                    </table>


                                </div>

                                <div class="modal fade" id="exampleModal14" tabindex="-1" role="dialog"
                                    aria-labelledby="exampleModalLabel4" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <form id="detailsForm" method="post" action="{{ url('teammapping/update') }}"
                                                enctype="multipart/form-data">
                                                @csrf
                                                <div class="modal-header">
                                                    <h5 class="modal-title font-weight-600" id="exampleModalLabel4">Add Team
                                                        Member</h5>
                                                    <div>
                                                        <ul>
                                                            @foreach ($errors->all() as $e)
                                                                <li style="color:red;">{{ $e }}</li>
                                                            @endforeach
                                                        </ul>
                                                    </div>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="details-form-field form-group row">
                                                        <div class="col-6">
                                                            <div class="form-group">
                                                                <label class="font-weight-600">Name</label>
                                                                <select class="language form-control"
                                                                    id="exampleFormControlSelect1" name="teammember_id">
                                                                    <option value="">Please Select One</option>
                                                                    @foreach ($teammemberall as $teammemberData)
                                                                        <option value="{{ $teammemberData->id }}">
                                                                            {{ $teammemberData->team_member }}
                                                                            ({{ $teammemberData->staffcode }})
                                                                        </option>
                                                                    @endforeach
                                                                </select>
                                                                <input type="text" hidden name="assignmentmapping_id"
                                                                    value="{{ $assignmentbudgetingDatas->id }}"
                                                                    class=" form-control" placeholder="Enter Client Name">
                                                            </div>
                                                        </div>
                                                        <div class="col-5">
                                                            <div class="form-group">
                                                                <label class="font-weight-600">Type</label>
                                                                <select class="form-control key" id="key"
                                                                    name="type">
                                                                    <option value="">Please Select One</option>
                                                                    <option value="0">Team Leader</option>
                                                                    <option value="2">Staff</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-danger"
                                                        data-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-success">Save</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <br>





Blade 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
resources\views\backEnd\viewassignment.blade.php
find text    <b>Teammember List:</b>
after  teammember list box add this box



                <div class="row">
                    <div class="col-md-12">
                        <div class="card" style="box-shadow:0 4px 8px 0 rgba(0, 0, 0, 0.2);height:250px;">

                            <div class="card-body">
                                <div class="card-head">
                                    <b>Assignment Viewer:</b>
                                    {{-- @if (auth()->user()->role_id != 15)
                                        <b><a data-toggle="modal" data-target="#exampleModal14"
                                                class="btn btn-info-soft btn-sm">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </b>
                                    @endif --}}
                                </div>

                                <hr>
                                <div class="table-responsive example">
                                    <table class="table display table-bordered table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Staff Code</th>
                                                <th>Role</th>
                                                <th>Mobile No</th>
                                                <th>Patner</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @php
                                                $hasData = false;
                                            @endphp
                                            @foreach ($teammemberDatas as $teammemberData)
                                                @if ($teammemberData->viewerteam == 1)
                                                    @php
                                                        $hasData = true;
                                                    @endphp
                                                    <tr>
                                                        <td>{{ $teammemberData->title }}
                                                            {{ $teammemberData->team_member }}</td>
                                                        <td>{{ $teammemberData->staffcode }}</td>
                                                        <td>
                                                            @if ($teammemberData->type == 0)
                                                                <span>Team Leader</span>
                                                            @else
                                                                <span>Staff</span>
                                                            @endif
                                                        </td>
                                                        <td>
                                                            <a
                                                                href="tel:={{ $teammemberData->mobile_no }}">{{ $teammemberData->mobile_no }}</a>
                                                        </td>
                                                        <td>{{ App\Models\Teammember::select('team_member')->where('id', $teammemberData->leadpartner)->first()->team_member ?? '' }}
                                                        </td>
                                                    </tr>
                                                @endif
                                            @endforeach
                                            @if (!$hasData)
                                                <tr>
                                                    <td colspan="7" style="text-align: center;">Data not available</td>
                                                </tr>
                                            @endif
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br>
                <br>






22222222222222222222222222222222222222222222222222222222222222222222222222222222222222
add this column in assignmentteammappings
1.viewerteam   type int, leanth 11, deafult 0

